FROM python:3.11@sha256:68a8863d0625f42d47e0684f33ca02f19d6094ef859a8af237aaf645195ed477

RUN apt-get update -y \
  && apt-get install -y --no-install-recommends \
  unzip=6.0-28 \
  python3=3.11.2-1+b1 \
  python3-pip=23.0.1+dfsg-1 \
  default-mysql-client=1.1.0 && \
  rm -rf /usr/lib/apt/lists/*

RUN pip3 install --no-cache-dir --break-system-packages \
  flask==2.2.2 \
  requests==2.28.1 \
  PyYAML==6.0 \
  gunicorn==20.1.0 \
  werkzeug==2.2.2 \
  mysql-connector-python==9.2.0

WORKDIR /app

RUN curl -L https://github.com/GaiZhenbiao/ChuanhuChatGPT/archive/40a0cc7018628b47948bd1a00e474e2350b45fe1.zip -o /app/chuanhu.zip && \
    unzip /app/chuanhu.zip -d /app && \
    mv /app/ChuanhuChatGPT-40a0cc7018628b47948bd1a00e474e2350b45fe1/* /app && \
    rm /app/chuanhu.zip

RUN pip install -r requirements.txt

RUN echo '{"language": "en_US","hide_history": false,"dark_mode": true,"show_api_type": true, "secret_API_key": "123key", "server_port": 9090}' > config.json # Bypass setup wizard

COPY entrypoint.sh /app/entrypoint.sh

COPY --from=docker /entrypoint.sh /entrypoint.sh
COPY --from=evaluation / /evaluator
ARG CVE
COPY --from=metadata /${CVE}.yml /cve_metadata.yml
