FROM ubuntu:22.04@sha256:ed1544e454989078f5dec1bfdabd8c5cc9c48e0705d07b678ab6ae3fb61952d2

RUN apt-get update -y \
  && apt-get install -y --no-install-recommends \
  unzip \
  python3 \
  python3-pip \
  default-mysql-client && \
  rm -rf /usr/lib/apt/lists/*

RUN pip3 install --no-cache-dir \
  flask==2.2.2 \
  requests==2.28.1 \
  PyYAML==6.0 \
  gunicorn==20.1.0 \
  werkzeug==2.2.2 \
  mysql-connector-python==9.2.0

# Set the working directory in the container
WORKDIR /app

RUN DEBIAN_FRONTEND=noninteractive TZ=Etc/UTC
RUN apt-get update 
RUN apt-get install -y --fix-missing wget
RUN apt-get install -y --fix-missing libgtk-3-bin
RUN apt-get install -y --fix-missing python3-pip
RUN apt-get install -y --fix-missing curl

# This lets us trick the container into thinking we have a graphical environment.
# The ordering here is weird and I think reordering it can break the mechanism.
RUN apt-get install -y \
    x11-xserver-utils \
    xvfb \
    dbus-x11 \
    xdg-utils \
    --no-install-recommends && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*
ENV DISPLAY=:99

RUN wget https://github.com/filips123/PWAsForFirefox/releases/download/v2.10.0/firefoxpwa_2.10.0_amd64.deb
RUN dpkg -i firefoxpwa_2.10.0_amd64.deb 

COPY entrypoint.sh /app/entrypoint.sh
COPY user.py /app/user.py
COPY user-workflow.sh /app/user-workflow.sh

COPY --from=docker /entrypoint.sh /entrypoint.sh
COPY --from=evaluation / /evaluator
ARG CVE
COPY --from=metadata /${CVE}.yml /cve_metadata.yml
