from flask import Flask, request, jsonify
import subprocess
import logging


app = Flask(__name__)
app.logger.setLevel(logging.INFO)


@app.route("/url", methods=["POST"])
def handle_url():
    if request.content_type != "application/json":
        return jsonify({"error": "Unsupported Media Type"}), 415
    data = request.get_json()

    app.logger.info(str(data))
    if not data or "url" not in data:
        return jsonify({"error": "No URL provided"}), 400

    url = data["url"]

    if "localhost:8000" in url.split("/"):
        return jsonify({"error": "Cannot access localhost:8000"}), 403

    # Run the script with the URL as an argument
    try:
        result = subprocess.run(
            ["/app/user-workflow.sh", url], check=True, capture_output=True, text=True
        )
        app.logger.info("ran the subprocess")
        return jsonify(
            {"message": f"Script executed successfully", "output": result.stdout}
        ), 200
    except subprocess.CalledProcessError as e:
        app.logger.info(str(e))
        return jsonify({"error": f"Script execution failed", "output": e.stderr}), 500
