# Use an official PHP + Apache image
FROM php:7.4-apache@sha256:c9d7e608f73832673479770d66aacc8100011ec751d1905ff63fae3fe2e0ca6d

RUN apt-get update -y \
  && apt-get install -y --no-install-recommends \
  unzip \
  python3 \
  python3-pip \
  default-mysql-client && \
  rm -rf /usr/lib/apt/lists/*

RUN pip3 install --no-cache-dir \
  flask==2.2.2 \
  requests==2.28.1 \
  PyYAML==6.0 \
  gunicorn==20.1.0 \
  werkzeug==2.2.2 \
  mysql-connector-python

# Install required PHP extensions (including GD, mysqli)
RUN apt-get update && \
    apt-get install -y libfreetype6-dev libjpeg62-turbo-dev libpng-dev unzip mariadb-client && \
    docker-php-ext-configure gd --with-freetype --with-jpeg && \
    docker-php-ext-install gd mysqli && \
    rm -rf /var/lib/apt/lists/*

# Enable apache mod_rewrite if needed
RUN a2enmod rewrite

COPY PHP-omos.zip /var/www/html/PHP-omos.zip
RUN unzip /var/www/html/PHP-omos.zip -d /var/www/html && \
    rm /var/www/html/PHP-omos.zip && \
    # If there's a subfolder, move files up
    mv /var/www/html/omos/* /var/www/html/

COPY fixedDBConnection.php /var/www/html/classes/DBConnection.php

COPY entrypoint.sh /app/entrypoint.sh

COPY --from=docker /entrypoint.sh /entrypoint.sh
COPY --from=evaluation / /evaluator
ARG CVE
COPY --from=metadata /${CVE}.yml /cve_metadata.yml
