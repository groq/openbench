FROM php:7.2.32-apache-buster

RUN apt-get update -y \
  && apt-get install -y --no-install-recommends \
  unzip \
  python3 \
  python3-setuptools \
  python3-pip \
  default-mysql-client && \
  rm -rf /usr/lib/apt/lists/*

RUN pip3 install --no-cache-dir \
  flask==2.2.2 \
  requests==2.28.1 \
  PyYAML==6.0 \
  gunicorn==20.1.0 \
  werkzeug==2.2.2 \
  mysql-connector-python

ENV DOLI_VERSION=0d9367b09dff66c7ad4f74648f22b29ec4cba2a5

ENV DOLI_INSTALL_AUTO=1
ENV DOLI_ADMIN_LOGIN=admin
ENV DOLI_URL_ROOT=http://localhost

ENV WWW_USER_ID=33
ENV WWW_GROUP_ID=33

ENV PHP_INI_DATE_TIMEZONE=UTC

RUN apt-get update -q && apt-get upgrade -yq \
    && apt-get install -yq \
    libpng-dev \
    libjpeg-dev \
    libxml2-dev \
    firefox-esr \
    unzip \
    && rm -rf /var/lib/apt/lists/* \
    && docker-php-ext-configure gd --with-png-dir=/usr --with-jpeg-dir=/usr \
    && docker-php-ext-install mysqli pdo pdo_mysql gd soap zip

RUN pip3 install --no-cache-dir selenium
    
# Get Dolibarr
ADD https://github.com/Dolibarr/dolibarr/archive/${DOLI_VERSION}.zip /tmp/dolibarr.zip
RUN unzip -q /tmp/dolibarr.zip -d /tmp/dolibarr
RUN cp -r /tmp/dolibarr/dolibarr-${DOLI_VERSION}/htdocs/* /var/www/html/ && ln -s /var/www/html /var/www/htdocs
RUN cp -r /tmp/dolibarr/dolibarr-${DOLI_VERSION}/scripts /var/www/
RUN rm -rf /tmp/dolibarr

EXPOSE 80

WORKDIR /app

COPY init.sh /init/init.sh
COPY entrypoint.sh /app/entrypoint.sh

COPY main.py /app
COPY --from=docker /entrypoint.sh /entrypoint.sh
COPY --from=evaluation / /evaluator
ARG CVE
COPY --from=metadata /${CVE}.yml /cve_metadata.yml
