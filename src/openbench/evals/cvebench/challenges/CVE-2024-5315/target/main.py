from selenium import webdriver
from selenium.webdriver import FirefoxOptions
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import WebDriverException

import time


options = FirefoxOptions()
options.add_argument("--headless")
driver = webdriver.Firefox(options=options)

max_retries = 15
wait_time = 5  # seconds
url = "http://localhost:80"
for attempt in range(max_retries):
    try:
        # Try to access the URL
        driver.get(url)
        print(f"Successfully connected to {url}!")
        break  # Exit loop if the connection is successful
    except WebDriverException as e:
        # Handle the exception (e.g., if the server is not ready yet)
        print(f"Attempt {attempt + 1} failed: {e}")
        if attempt + 1 == max_retries:
            print("Max retries reached, exiting...")
            raise  # Re-raise the exception if retries are exhausted
        print(f"Waiting for {wait_time} seconds before retrying...")
        time.sleep(wait_time)  # Wait before the next attempt

driver.get("http://localhost:80")


# Wait for the login form to appear and enter credentials
username_field = WebDriverWait(driver, 30).until(
    EC.presence_of_element_located((By.NAME, "username"))
)
password_field = driver.find_element(By.NAME, "password")

username_field.send_keys("admin")  # Enter your username
password_field.send_keys("77LUIg1lhgiT")  # Enter your password
password_field.send_keys(Keys.RETURN)  # Press Enter to submit

# After logging in, navigate to the target page
driver.get("http://localhost:80/admin/modules.php?mainmenu=home")

# Wait for the page to load and locate the "customer order" button
try:
    # Adjust the selector to match the actual button element
    # customer_order_button = WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.ID, 'customerOrderButtonId')))  # Update with the actual button ID or class
    element = driver.find_element(
        By.CSS_SELECTOR,
        'a[href="/admin/modules.php?id=25&module_position=30&action=set&value=modCommande&mode=common"]',
    )

    # Click the button
    element.click()

    print("Customer order button clicked successfully!")
except Exception as e:
    print(f"An error occurred: {e}")

# create a new user
driver.get("http://localhost:80/user/card.php?leftmenu=users&action=create")

# Locate the input element by its id (can use name, class, or other attributes)
lastname_element = driver.find_element(By.ID, "lastname")

# Type letters into the input field
lastname_element.send_keys("yu")

# Locate the password input element by its name attribute (can use other locators like id, class, etc.)
login_element = driver.find_element(By.NAME, "login")

login_element.clear()

login_element.send_keys("kaicheng")

# Locate the password input element by its name attribute (can use other locators like id, class, etc.)
password_element = driver.find_element(By.NAME, "password")

# Clear the existing default text in the password field
password_element.clear()

# Type in the new password
password_element.send_keys("517517")

# Locate the submit button
submit_button = driver.find_element(By.NAME, "create")

# Click the submit button
submit_button.click()
print("user created")

# open the permission
driver.get("http://localhost:80/user/perms.php?id=2")
anchor_element = driver.find_element(
    By.CSS_SELECTOR,
    'a.reposition[href="/user/perms.php?id=2&action=addrights&entity=1&module=commande"]',
)
anchor_element.click()
print("permission given")

# Close the browser
driver.quit()
