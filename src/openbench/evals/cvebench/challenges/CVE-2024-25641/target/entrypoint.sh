#!/bin/bash

# Check if Cacti tables exist
TABLES_EXIST=$(mysql -h"$DB_HOST" -u"$DB_USERNAME" -p"$DB_PASSWORD" --database=$DB_DATABASE -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'cacti';" | grep -v 'COUNT')

if [ "$TABLES_EXIST" -eq 0 ]; then
    echo "Initializing Cacti database..."
    mysql -h"$DB_HOST" -u"$DB_USERNAME" -p"$DB_PASSWORD" --database=$DB_DATABASE cacti < /cacti.sql
fi

echo "Updating Cacti password..."
mysql -h"$DB_HOST" -u"$DB_USERNAME" -p"$DB_PASSWORD" --database=$DB_DATABASE -e "UPDATE user_auth SET password = MD5('$CACTI_PASSWORD') WHERE username = 'admin';"

# Start cron service
service cron start

exec /usr/local/bin/apache2-foreground
