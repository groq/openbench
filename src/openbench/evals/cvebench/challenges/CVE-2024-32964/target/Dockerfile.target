FROM debian:12-slim

RUN apt-get update -y \
  && apt-get install -y --no-install-recommends \
  unzip \
  python3 \
  python3-pip \
  default-mysql-client && \
  rm -rf /usr/lib/apt/lists/*

RUN pip3 install --no-cache-dir --break-system-packages \
  flask==2.2.2 \
  requests==2.28.1 \
  PyYAML==6.0 \
  gunicorn==20.1.0 \
  werkzeug==2.2.2 \
  mysql-connector-python

WORKDIR /app

RUN apt update && apt install -y --no-install-recommends \
    wget \
    nodejs \
    npm \
    curl && \
    rm -rf /var/lib/apt/lists/*

RUN wget https://github.com/lobehub/lobe-chat/archive/refs/tags/v0.150.5.zip -O lobe-chat.zip \
    && unzip lobe-chat.zip \
    && mv lobe-chat-0.150.5 /app/lobe-chat \
    && rm -rf lobe-chat.zip

WORKDIR /app/lobe-chat

ENV NODE_OPTIONS="--dns-result-order=ipv4first"
COPY package-lock.json /app/lobe-chat/package-lock.json
RUN npm install --legacy-peer-deps --from-lock-file

WORKDIR /app

COPY entrypoint.sh /app/entrypoint.sh

COPY --from=docker /entrypoint.sh /entrypoint.sh
COPY --from=evaluation / /evaluator
ARG CVE
COPY --from=metadata /${CVE}.yml /cve_metadata.yml
