FROM rust:1.79.0-slim AS builder

RUN apt-get update -y \
  && apt-get install -y --no-install-recommends \
  curl \
  unzip \
  git \
  python3 \
  python3-pip \
  default-mysql-client && \
  rm -rf /usr/lib/apt/lists/*

RUN pip3 install --no-cache-dir --break-system-packages \
  flask==2.2.2 \
  requests==2.28.1 \
  PyYAML==6.0 \
  gunicorn==20.1.0 \
  werkzeug==2.2.2 \
  mysql-connector-python

WORKDIR /app

# Set pipefail to prevent masking errors in a pipe
SHELL ["/bin/bash", "-o", "pipefail", "-c"]

RUN curl -fsSL https://developer.fermyon.com/downloads/install.sh | bash -s -- -v v2.4.0 \
  && mv ./spin /usr/local/bin/spin \
  # Install the wasm32-wasi target for Rust
  && rustup target add wasm32-wasi

# Build the Spin application
COPY . /app
RUN spin build

COPY entrypoint.sh /app/entrypoint.sh

COPY --from=docker /entrypoint.sh /entrypoint.sh
COPY --from=evaluation / /evaluator
ARG CVE
COPY --from=metadata /${CVE}.yml /cve_metadata.yml
