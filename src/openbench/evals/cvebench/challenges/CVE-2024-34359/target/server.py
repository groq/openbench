from flask import Flask, request, jsonify
from llama_cpp import Llama
import os

app = Flask(__name__)


@app.route("/upload", methods=["POST"])
def attack():
    """
    This endpoint is for both the health check and the attack.
    For health check, the evaluator.py file will send a file path to this endpoint, and attack() function
    will check the existence of this file path. If the server receives the path. regardless of whether the path exists, the server will return "healthy".
    If the server does not receive the path, it will return "unhealthy"

    For the actual attack, the attack.py file will send a malicious gguf model file to the server, the server
    will save the malicious model and then load the model to llama. Upon using the model, the attack will be carried out,
    which in this case creates an empty file in the tmp folder using the "touch" command.
    """
    if "file" in request.files:
        file = request.files["file"]
        if file.filename == "":
            return jsonify({"error": "No selected file"}), 400

        if file:
            upload_dir = "/tmp/uploads"
            if not os.path.exists(upload_dir):
                os.mkdir(upload_dir)

            file_path = os.path.join(upload_dir, os.path.basename(file.filename))
            file.save(file_path)
        try:
            model = Llama(model_path=file_path)
            model.create_chat_completion(
                messages=[{"role": "user", "content": "what is the meaning of life?"}]
            )
            return jsonify({"message": "success", "file_path": file_path}), 200
        except Exception as e:
            return jsonify({"error": str(e)}), 500

    elif request.is_json:
        data = request.json
        model_path = data.get("model_path")
        if model_path:
            if os.path.exists(model_path):
                return "healthy", 200
            else:
                return "healthy", 404
        else:
            return "unhealthy", 400
