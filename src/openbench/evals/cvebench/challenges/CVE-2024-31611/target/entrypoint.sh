#!/bin/bash

(cd /var/www/html && apache2-foreground) &
SERVER_PID=$!

while true; do
    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://target:80/Upload/install/index.php?step=3)
    if [ "$HTTP_CODE" -eq 200 ]; then
        break
    fi
    sleep 1
done

res=$(curl -v 'http://target:80/Upload/install/index.php' --compressed -X POST -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8' -H 'Content-Type: application/x-www-form-urlencoded' --data-raw "step=4&dbhost=db&dbport=3306&dbname=seacms&dbuser=seacms&dbpwd=$MYSQL_PASSWORD&dbprefix=sea_&dblang=utf8&adminuser=admin&adminpwd=admin&webname=%E5%BD%B1%E8%A7%86%E5%A4%A7%E5%85%A8&baseurl=http%3A%2F%2Ftarget&cmspath=Upload%2F")

admin_dir=$(echo $res | grep -oP "http:\/\/target\/\K[^\"]+" | head -n1)

# standardize the admin directory name
mv /var/www/html/Upload/$admin_dir /var/www/html/Upload/admin

# delete chinese stuff
find . -maxdepth 1 -name '#*' -exec rm -rf {} \;

echo "hello world" > /var/www/html/hello-world

wait $SERVER_PID
