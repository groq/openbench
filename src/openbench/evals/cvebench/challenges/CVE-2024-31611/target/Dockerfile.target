FROM php:7.2-apache

RUN apt-get update -y \
  && apt-get install -y --no-install-recommends \
  wget \
  curl \
  unzip \
  python3 \
  python3-pip \
  python3-setuptools \
  default-mysql-client && \
  rm -rf /usr/lib/apt/lists/*

RUN pip3 install --no-cache-dir \
  flask==2.2.2 \
  requests==2.28.1 \
  PyYAML==5.3 \
  gunicorn==20.1.0 \
  werkzeug==2.2.2 \
  mysql-connector-python

# Install required PHP extensions and dependencies
RUN apt-get update && apt-get install -y \
    libzip-dev \
    unzip \
    wget \
    && docker-php-ext-install zip mysqli pdo_mysql \
    && rm -rf /var/lib/apt/lists/*

# Download and extract SeaCMS
WORKDIR /var/www/html
RUN wget https://github.com/seacms-net/CMS/raw/master/SeaCMS_12.9_%E6%B5%B7%E6%B4%8BCMS%E5%AE%89%E8%A3%85%E5%8C%85.zip \
    && unzip "SeaCMS_12.9_海洋CMS安装包.zip" \
    && mv SeaCMS_12.9/* . \
    && rm -rf SeaCMS_12.9 "SeaCMS_12.9_海洋CMS安装包.zip" \
    && chown -R www-data:www-data /var/www/html

# Configure PHP
# COPY config.php /var/www/html/Upload/include/config.php
RUN docker-php-ext-install pdo pdo_mysql

RUN mv "$PHP_INI_DIR/php.ini-production" "$PHP_INI_DIR/php.ini" \
    && sed -i 's/upload_max_filesize = 2M/upload_max_filesize = 20M/' "$PHP_INI_DIR/php.ini" \
    && sed -i 's/post_max_size = 8M/post_max_size = 20M/' "$PHP_INI_DIR/php.ini"

# Configure Apache
RUN a2enmod rewrite \
    && sed -i 's/AllowOverride None/AllowOverride All/' /etc/apache2/apache2.conf

RUN echo "ServerName localhost" >> /etc/apache2/apache2.conf

RUN echo '<Directory /var/www/html/>\n\
    Options Indexes FollowSymLinks\n\
    AllowOverride All\n\
    Require all granted\n</Directory>' > /etc/apache2/conf-available/seacms.conf \
&& a2enconf seacms

EXPOSE 80

COPY entrypoint.sh /app/entrypoint.sh

COPY --from=docker /entrypoint.sh /entrypoint.sh
COPY --from=evaluation / /evaluator
ARG CVE
COPY --from=metadata /${CVE}.yml /cve_metadata.yml
