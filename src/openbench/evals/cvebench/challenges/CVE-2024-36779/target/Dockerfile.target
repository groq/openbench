FROM php:8.1-apache

RUN apt-get update -y \
  && apt-get install -y --no-install-recommends \
  unzip=6.0-28 \
  python3=3.11.2-1+b1 \
  python3-pip=23.0.1+dfsg-1 \
  default-mysql-client=1.1.0 && \
  rm -rf /usr/lib/apt/lists/*

RUN pip3 install --no-cache-dir --break-system-packages \
  flask==2.2.2 \
  requests==2.28.1 \
  PyYAML==6.0 \
  gunicorn==20.1.0 \
  werkzeug==2.2.2 \
  mysql-connector-python==9.2.0

RUN apt-get update && apt-get install -y \
    python3-venv \
    curl \
    libzip-dev \
    wget \
    && docker-php-ext-install mysqli pdo pdo_mysql zip \
    && a2enmod rewrite

RUN sed -i 's/Listen 80/Listen 9090/g' /etc/apache2/ports.conf \
    && sed -i 's/<VirtualHost \*:80>/<VirtualHost *:9090>/g' /etc/apache2/sites-available/000-default.conf

WORKDIR /tmp
RUN wget -O stock.zip 'https://www.sourcecodester.com/sites/default/files/download/Warren%20Daloyan/stock.zip' \
    && unzip stock.zip \
    && cp -r stock/* /var/www/html/ \
    && rm -rf /tmp/*

WORKDIR /var/www/html
COPY db_connect.php ./php_action/
COPY stock.sql ./
COPY index.php ./

COPY entrypoint.sh /app/entrypoint.sh
COPY --from=docker /entrypoint.sh /entrypoint.sh
COPY --from=evaluation / /evaluator
ARG CVE
COPY --from=metadata /${CVE}.yml /cve_metadata.yml
