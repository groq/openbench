---
name: Publish openbench-core to pyx

'on':
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      team:
        description: 'pyx team slug (overrides repo var PYX_TEAM)'
        required: false
        type: string
      registry:
        description: 'pyx registry name'
        required: false
        default: 'main'
        type: string

permissions:
  contents: read

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          persist-credentials: false

      - name: Set up uv
        uses: astral-sh/setup-uv@be7fc19b4169c26a2aa1b8a430af391f2a96b3c9

      - name: Resolve pyx target
        id: target
        shell: bash
        run: |
          TEAM_INPUT="${{ inputs.team }}"
          TEAM_VAR="${{ vars.PYX_TEAM }}"
          TEAM="${TEAM_INPUT:-$TEAM_VAR}"
          if [ -z "$TEAM" ]; then
            echo "::error::pyx team not provided." >&2
            echo "Set repo variable PYX_TEAM" >&2
            echo "or provide workflow input 'team'." >&2
            exit 1
          fi
          REGISTRY_INPUT="${{ inputs.registry }}"
          REGISTRY="${REGISTRY_INPUT:-main}"
          echo "team=$TEAM" >> "$GITHUB_OUTPUT"
          echo "registry=$REGISTRY" >> "$GITHUB_OUTPUT"
          URL="https://api.pyx.dev/v1/upload/${TEAM}/${REGISTRY}"
          echo "url=$URL" >> "$GITHUB_OUTPUT"

      - name: Compute dev version and patch pyproject
        working-directory: packages/openbench-core
        shell: bash
        run: |
          set -euo pipefail
          BASE_VERSION=$( \
            grep -E '^version[[:space:]]*=[[:space:]]*"' pyproject.toml | \
            head -n1 | \
            sed -E 's/^version[[:space:]]*=[[:space:]]*"([^"]+)"/\1/' \
          )
          DATE=$(date -u +%Y%m%d)
          RUN_NUM="${{ github.run_number }}"
          NEW_VERSION="${BASE_VERSION}.dev${DATE}${RUN_NUM}"
          cp pyproject.toml pyproject.toml.bak
          P1='s/^version[[:space:]]*=[[:space:]]*\"[^\"]+\"/version = \"'
          P2='\"/'
          PATTERN="$P1${NEW_VERSION//\//-}$P2"
          sed -i.bak -E "$PATTERN" pyproject.toml
          echo "version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build distributions
        working-directory: packages/openbench-core
        run: uv build --sdist --wheel

      - name: Upload build artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        with:
          name: openbench-core-dists
          path: packages/openbench-core/dist/*

      - name: Authenticate to pyx (Trusted Publishing)
        id: auth
        uses: astral-sh/pyx-auth-action@08873fa2b19cf2361327222bea1657faed760ae2
        with:
          workspace: ${{ steps.target.outputs.team }}
          registry: ${{ steps.target.outputs.registry }}

      - name: Publish to pyx
        working-directory: packages/openbench-core
        env:
          UV_PUBLISH_URL: ${{ steps.auth.outputs.url }}
          UV_PUBLISH_TOKEN: ${{ steps.auth.outputs.token }}
        run: uv publish dist/*
